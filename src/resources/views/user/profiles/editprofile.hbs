<div class="container mt-3 mb-5">
  <h2 class="mb-4">Sửa thông tin cá nhân</h2>
  <form method="POST" action="/profile/{{user._id}}?_method=PUT" enctype="multipart/form-data">
    <div class="row">
      <div class="text-center mb-5">
        <div class="cover-wrapper-profile mt-4">
          <img 
            src="{{#if user.avatar}}{{user.avatar}}{{else}}/img/avatar.jpg{{/if}}"
            id="avatarPhoto"
            class="avatar-img-profile"
            alt="Avatar"
            style="cursor: pointer;"
          >
        </div>
        <button type="button" class="btn btn-primary mt-4" id="btnChangeAvatar">Đổi ảnh</button>
        <input
          type="file"
          id="avatarInput"
          name="avatar"
          accept="image/*"
          style="display: none;"
        >
      </div>
      
      <div class="col-md-6">
        <div class="mb-3">
          <label class="form-label">Họ và tên</label>
          <input type="text" class="form-control" value="{{user.fullName}}" disabled>
        </div>

        <div class="mb-3">
          <label class="form-label">Email</label>
          <input type="email" class="form-control" value="{{user.email}}" disabled>
        </div>

        <div class="mb-3">
          <label class="form-label">Số điện thoại</label>
          <input type="text" class="form-control" value="{{user.phoneNumber}}" disabled>
        </div>

        <div class="mb-3">
          <label class="form-label">Ngày sinh</label>
          <input type="date" class="form-control" name="dateOfBirth" value="{{user.formattedDateOfBirth}}">
        </div>

        <div class="mb-3">
          <label class="form-label">Giới tính</label>
          <select class="form-select" name="gender">
            <option value="Nam" {{#if (eq user.gender "Nam")}}selected{{/if}}>Nam</option>
            <option value="Nữ" {{#if (eq user.gender "Nữ")}}selected{{/if}}>Nữ</option>
            <option value="Khác" {{#if (eq user.gender "Khác")}}selected{{/if}}>Khác</option>
          </select>
        </div>

        <div class="mb-3">
          <label class="form-label">Tình trạng hôn nhân</label>
          <select class="form-select" name="maritalStatus">
            <option value="Độc thân" {{#if (eq user.maritalStatus "Độc thân")}}selected{{/if}}>Độc thân</option>
            <option value="Đã kết hôn" {{#if (eq user.maritalStatus "Đã kết hôn")}}selected{{/if}}>Đã kết hôn</option>
            <option value="Hẹn hò" {{#if (eq user.maritalStatus "Hẹn hò")}}selected{{/if}}>Hẹn hò</option>
          </select>
        </div>

        <div class="mb-3">
          <label class="form-label">Chức vụ</label>
          <input type="text" class="form-control" name="position" value="{{user.position}}">
        </div>

        <div class="mb-3">
          <label class="form-label">Mã nhân viên</label>
          <input type="text" class="form-control" name="employeeId" value="{{user.employeeId}}">
        </div>
      </div>

      <div class="col-md-6">
        <div class="mb-3">
          <label class="form-label">Nơi ở hiện tại</label>
          <select class="form-select" id="currentProvince" name="currentProvince">
            <option value="">Chọn tỉnh/thành phố</option>
          </select>
        </div>

        <div class="mb-3">
          <label class="form-label">Quê quán</label>
          <select class="form-select" id="hometownProvince" name="hometownProvince">
            <option value="">Chọn tỉnh/thành phố</option>
          </select>
        </div>

        <div class="mb-3">
          <label class="form-label">Bí danh</label>
          <input type="text" class="form-control" name="nickname" value="{{user.nickname}}">
        </div>
        
        <div class="mb-3">
          <label class="form-label">Sở thích</label>
          <div class="row" 
            id="hobbiesContainer" 
            data-selected='[{{#each user.hobbies}}"{{this}}"{{#unless @last}},{{/unless}}{{/each}}]'>
          </div>
        </div>

        <div class="mb-3">
          <label class="form-label">Facebook</label>
          <input type="text" class="form-control" name="socialMedia.facebook" value="{{user.socialMedia.facebook}}">
        </div>

        <div class="mb-3">
          <label class="form-label">LinkedIn</label>
          <input type="text" class="form-control" name="socialMedia.linkedin" value="{{user.socialMedia.linkedin}}">
        </div>
        
        <div class="mb-3">
          <label class="form-label">Instagram</label>
          <input type="text" class="form-control" name="socialMedia.instagram" value="{{user.socialMedia.instagram}}">
        </div>
      </div>

      <div class="text-center mt-4">
        <a href="/profile/{{user._id}}/about" class="btn btn-secondary ms-2">Quay lại</a>
        <button type="submit" class="btn btn-success">Lưu thay đổi</button>
      </div>
    </div>
  </form>
</div>

<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
  document.getElementById("btnChangeAvatar").addEventListener("click", () => {
    document.getElementById("avatarInput").click();
  });

  document.getElementById("avatarInput").addEventListener("change", (e) => {
    const file = e.target.files[0];
    if (file) {
      const preview = document.getElementById("avatarPhoto");
      preview.src = URL.createObjectURL(file);
    }
  });
  const selectedCurrentProvince = "{{user.currentProvince}}";
  const selectedHometownProvince = "{{user.hometownProvince}}";

  loadProvinces("current", selectedCurrentProvince);
  loadProvinces("hometown", selectedHometownProvince);

  function loadProvinces(type, selectedProvinceName) {
  fetch('https://provinces.open-api.vn/api/p/')
    .then(res => res.json())
    .then(data => {
      const select = document.getElementById(`${type}Province`);
      data.forEach(p => {
        const opt = document.createElement('option');
        opt.value = p.name;
        opt.textContent = p.name;
        select.appendChild(opt);
      });
      if (selectedProvinceName) {
        select.value = selectedProvinceName;
      }
    });
}

  const hobbiesList = [
    "Đọc sách", "Nghe nhạc", "Du lịch", "Nấu ăn", "Chụp ảnh", "Thể thao",
    "Xem phim", "Mua sắm", "Chơi game", "Lập trình", "Viết lách", "Vẽ tranh",
    "Tập gym", "Yoga", "Cắm trại"
  ];

  const container = document.getElementById("hobbiesContainer");

  // Đọc dữ liệu hobbies đã chọn (nếu có)
  let selectedHobbies = [];
  try {
    const selectedString = container.dataset.selected || "[]";
    selectedHobbies = JSON.parse(selectedString);
  } catch (e) {
    selectedHobbies = [];
  }

  // Sinh checkbox
  hobbiesList.forEach((hobby, index) => {
    const col = document.createElement("div");
    col.className = "col-md-4";

    const div = document.createElement("div");
    div.className = "form-check";

    const input = document.createElement("input");
    input.className = "form-check-input";
    input.type = "checkbox";
    input.id = `hobby-${index}`;
    input.name = "hobbies";
    input.value = hobby;

    if (selectedHobbies.includes(hobby)) {
      input.checked = true;
    }

    const label = document.createElement("label");
    label.className = "form-check-label";
    label.setAttribute("for", `hobby-${index}`);
    label.textContent = hobby;

    div.appendChild(input);
    div.appendChild(label);
    col.appendChild(div);
    container.appendChild(col);
  });
</script>