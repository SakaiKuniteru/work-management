<div class="container mt-3">
    <div class="cover-wrapper position-relative">
        <!-- Ảnh bìa -->
        <a href="{{#if user.coverPhoto}}{{user.coverPhoto}}{{else}}/img/coverphoto.jpg{{/if}}">
            <img 
                src="{{#if user.coverPhoto}}{{user.coverPhoto}}{{else}}/img/coverphoto.jpg{{/if}}" 
                id="coverPhoto"
                class="w-100 rounded"
                style="height: 300px; object-fit: cover;"
                alt="Ảnh bìa"
            >
        </a>

        <!-- Nút camera đổi ảnh bìa -->
        <button 
            class="btn btn-light btn-sm position-absolute top-0 end-0 m-2" 
            id="changeCoverBtn"
            title="Đổi ảnh bìa">
            <i class="bi bi-camera"></i>
        </button>

        <!-- Avatar container -->
        <div class="avatar-container">
            <div class="avatar-wrapper">
                <img 
                    src="{{#if user.avatar}}{{user.avatar}}{{else}}/img/avatar.jpg{{/if}}" 
                    id="avatarPhoto"
                    class="avatar-img dropdown-toggle"
                    data-bs-toggle="dropdown"
                    aria-expanded="false"
                    alt="Avatar"
                    style="cursor: pointer;"
                >
                <button 
                    class="btn btn-light btn-sm change-avatar-btn" 
                    id="changeAvatarBtn" 
                    title="Đổi ảnh đại diện">
                    <i class="bi bi-camera"></i>
                </button>

                <ul class="dropdown-menu">
                    <li>
                        <a class="dropdown-item" href="#" id="uploadAvatar">
                            <i class="bi bi-upload me-2"></i>
                            Thêm ảnh mới
                        </a>
                    </li>
                    <li>
                        <a class="dropdown-item" href="{{#if user.avatar}}{{user.avatar}}{{else}}/img/avatar.jpg{{/if}}">
                            <i class="bi bi-eye me-2"></i>
                            Xem ảnh
                        </a>
                    </li>
                </ul>
            </div>
        </div>
    </div>

    <input type="file" id="coverInput" accept="image/*" hidden>
    <input type="file" id="avatarInput" accept="image/*" hidden>

    <!-- Profile info -->
    <div class="mt-3 d-flex justify-content-between align-items-center flex-wrap">
        <div>
            <h2 class="profile-name mb-0">{{user.fullName}}</h2>
            <small class="text-muted">100 Đồng nghiệp</small>
        </div>
    </div>

    <!-- Tabs -->
    <ul class="nav nav-tabs mt-4" id="profileTabs" role="tablist">
        <li class="nav-item" role="presentation">
            <a class="nav-link {{#if (eq activeTab 'posts')}}active{{/if}}" href="/profiles/{{user._id}}/posts">Bài viết</a>
        </li>
        <li class="nav-item" role="presentation">
            <a class="nav-link {{#if (eq activeTab 'about')}}active{{/if}}" href="/profiles/{{user._id}}/about">Giới thiệu</a>
        </li>
        <li class="nav-item" role="presentation">
            <a class="nav-link {{#if (eq activeTab 'dashboard')}}active{{/if}}" href="/profiles/{{user._id}}/dashboard">Bảng điều khiển</a>
        </li>
        <li class="nav-item" role="presentation">
            <a class="nav-link {{#if (eq activeTab 'photos')}}active{{/if}}" href="/profiles/{{user._id}}/photos">Ảnh</a>
        </li>
    </ul>

    <!-- Nội dung của tab -->
    <div class="tab-content p-3 bg-white border border-top-0 rounded-bottom" id="profileTabsContent">
        {{#if (eq activeTab 'posts')}}
            {{> user/profiles/posts}}
        {{else if (eq activeTab 'about')}}
            {{> user/profiles/about}}
        {{else if (eq activeTab 'dashboard')}}
            {{> user/profiles/dashboard}}
        {{else if (eq activeTab 'photos')}}
            {{> user/profiles/photos}}
        {{else}}
            {{> user/profiles/posts}}
        {{/if}}
    </div>
</div>

<!-- Chart.js (chỉ cần cho dashboard) -->
{{#if (eq activeTab 'dashboard')}}
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
{{/if}}

<!-- JavaScript cho upload ảnh -->
<script>
    document.getElementById("changeCoverBtn").addEventListener("click", () => {
        document.getElementById("coverInput").click();
    });

    document.getElementById("coverInput").addEventListener("change", async (e) => {
        const file = e.target.files[0];
        if (file) {
            const formData = new FormData();
            formData.append('cover', file);

            try {
                const response = await fetch('/profile/update-cover', {
                    method: 'POST',
                    body: formData
                });
                const result = await response.json();
                if (result.success) {
                    document.getElementById("coverPhoto").src = result.coverPhoto;
                } else {
                    alert(result.message);
                }
            } catch (err) {
                alert('Có lỗi khi tải ảnh bìa.');
            }
        }
    });

    document.getElementById("changeAvatarBtn").addEventListener("click", () => {
        document.getElementById("avatarInput").click();
    });

    document.getElementById("avatarInput").addEventListener("change", async (e) => {
        const file = e.target.files[0];
        if (file) {
            const formData = new FormData();
            formData.append('avatar', file);

            try {
                const response = await fetch('/profile/update-avatar', {
                    method: 'POST',
                    body: formData
                });
                const result = await response.json();
                if (result.success) {
                    document.getElementById("avatarPhoto").src = result.avatar;
                } else {
                    alert(result.message);
                }
            } catch (err) {
                alert('Có lỗi khi tải ảnh đại diện.');
            }
        }
    });

    document.getElementById("uploadAvatar").addEventListener("click", (e) => {
        e.preventDefault();
        document.getElementById("avatarInput").click();
    });
</script>