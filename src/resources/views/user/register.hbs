<!DOCTYPE html>
<html lang="vi">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
        <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
        <link rel="stylesheet" href="css/user/form.css">
        <link rel="stylesheet" href="css/boostrap.css">
        <title>Đăng Ký</title>
    </head>

    <body>
        <div class="container d-flex justify-content-center align-items-center auth-container" style="min-height: 100vh;">
            <div class="card card-custom" style="max-width: 500px; width: 100%;">
            
                <div class="text-center mb-4">
                    <h3 class="mt-3">Tạo tài khoản của bạn</h3>
                </div>

                <!-- Register Form -->
                <form id="registerForm" action="/register" method="post" novalidate>
                    <div class="mb-3">
                        <label class="form-label">Họ và tên</label>
                        <div class="input-group">
                            <span class="input-group-text"><i class="fa fa-user"></i></span>
                            <input 
                                type="text" 
                                class="form-control" 
                                placeholder="Phạm Văn A" 
                                required 
                                name="fullName" 
                                id="fullName" 
                                value="{{userData.fullName}}">
                        </div>

                        <div class="text-danger small" id="error-fullName">{{errors.fullName}}</div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Số điện thoại</label>
                        <div class="input-group">
                            <span class="input-group-text"><i class="fa fa-phone"></i></span>
                            <input 
                                type="tel" 
                                class="form-control" 
                                placeholder="098 765 4321" 
                                required 
                                name="phoneNumber" 
                                id="phoneNumber" 
                                value="{{userData.phoneNumber}}">
                        </div>
                        <div class="text-danger small" id="error-phoneNumber">{{errors.phoneNumber}}</div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Email</label>
                        <div class="input-group">
                            <span class="input-group-text"><i class="fa fa-envelope"></i></span>
                            <input 
                                type="email" 
                                class="form-control" 
                                placeholder="abc@example.com" 
                                required name="email" 
                                id="email" 
                                value="{{userData.email}}">
                        </div>
                        <div class="text-danger small" id="error-email">{{errors.email}}</div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Mật khẩu</label>
                        <div class="input-group">
                            <span class="input-group-text"><i class="fa fa-lock"></i></span>
                            <input type="password" class="form-control" placeholder="Abc1234@" required name="password" id="password">
                            <button class="btn btn-outline-secondary" type="button" id="togglePassword">
                                <i class="fa fa-eye"></i>
                            </button>
                        </div>
                        <div class="text-danger small" id="error-password">{{errors.password}}</div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Xác nhận mật khẩu</label>
                        <div class="input-group">
                            <span class="input-group-text"><i class="fa fa-lock"></i></span>
                            <input type="password" class="form-control" placeholder="Abc1234@" required name="confirmPassword" id="confirmPassword">
                            <button class="btn btn-outline-secondary" type="button" id="toggleConfirmPassword">
                                <i class="fa fa-eye"></i>
                            </button>
                        </div>
                        <div class="text-danger small" id="error-confirmPassword">{{errors.confirmPassword}}</div>
                    </div>

                    <button type="submit" class="btn btn-success w-100 rounded-pill py-2">Đăng ký</button>
                </form>

                <!-- Form OTP -->
                <div id="otpSection" style="display: none;">
                    <hr class="my-4">
                    <div class="d-flex align-items-center mb-3">
                        <button type="button" id="backToRegister" class="btn btn-link p-0 me-2 text-decoration-none">
                            <i class="fa fa-arrow-left fa-lg"></i>
                        </button>
                        <h3 class="m-0">Xác thực OTP</h3>
                    </div>
                    <p class="text-center mb-4">
                        Chúng tôi đã gửi mã xác thực (OTP) đến <strong id="display-email"></strong>. Vui lòng nhập mã để hoàn tất đăng ký. Mã có hiệu lực trong 10 phút.
                    </p>
                    <div class="alert alert-danger" id="error-otp" style="display: none;"></div>
                    <form id="otpForm" action="/register/verify-otp" method="post">
                        <input type="hidden" name="email" id="hidden-email">
                        <div class="mb-3">
                            <label class="form-label">Mã OTP</label>
                            <input type="text" class="form-control" name="otp" placeholder="Nhập mã OTP" required id="otp-input">
                        </div>
                        <button type="submit" class="btn btn-primary w-100 rounded-pill py-2">Xác thực</button>
                    </form>

                    <div class="text-center mt-3">
                        <button id="resendOTPBtn" class="btn btn-link" disabled>Gửi lại mã OTP (<span id="countdown">60</span>s)</button>
                    </div>
                </div>

                <div class="text-center mt-3">
                    <h6>
                        Bạn đã có tài khoản? 
                        <a href="/login" class="text-decoration-none">
                            Đăng Nhập
                        </a>
                    </h6>
                </div>

                <hr class="my-4">

                <p class="text-center fw-bold mb-3">Hoặc Đăng Ký Bằng</p>

                <a href="#" class="btn btn-outline-danger btn-social">
                    <i class="fab fa-google"></i> Đăng nhập bằng Google
                </a>

                <a href="#" class="btn btn-outline-primary btn-social">
                    <i class="fab fa-facebook"></i> Đăng nhập bằng Facebook
                </a>

                <a href="#" class="btn btn-outline-dark btn-social">
                    <i class="fab fa-apple"></i> Đăng nhập bằng Apple
                </a>

                <a href="#" class="btn btn-outline-info btn-social">
                    <i class="fab fa-twitter"></i> Đăng nhập bằng Twitter
                </a>

                <a href="#" class="btn btn-outline-secondary btn-social">
                    <i class="fa fa-envelope"></i> Đăng nhập bằng email
                </a>
            </div>
        </div>
        
        <script>
            document.getElementById("registerForm").addEventListener("submit", function(e) {
                e.preventDefault();

                const fullName = document.getElementById("fullName").value;
                const phoneNumber = document.getElementById("phoneNumber").value;
                const email = document.getElementById("email").value;
                const password = document.getElementById("password").value;
                const confirmPassword = document.getElementById("confirmPassword").value;

                fetch("/register", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                    },
                    body: JSON.stringify({
                        fullName,
                        phoneNumber,
                        email,
                        password,
                        confirmPassword
                    }),
                })
                .then((res) => res.json())
                .then((data) => {
                    if (data.success) {
                        // Chuyển sang form OTP mà không hiển thị alert
                        document.getElementById("registerForm").style.display = "none";
                        document.getElementById("otpSection").style.display = "block";
                        document.getElementById("hidden-email").value = data.email;
                        document.getElementById("display-email").textContent = data.email;
                    } else {
                        const fields = ["fullName", "phoneNumber", "email", "password", "confirmPassword"];
                        fields.forEach((field) => {
                            const errEl = document.getElementById(`error-${field}`);
                            const inputEl = document.getElementById(field);
                            if (errEl) {
                                errEl.textContent = data.errors?.[field] || "";
                            }
                            if (inputEl && data.userData?.[field]) {
                                inputEl.value = data.userData[field];
                            }
                        });
                        if (data.errors.general) {
                            alert(data.errors.general);
                        }
                    }
                })
                .catch(err => {
                    console.error(err);
                    alert("Lỗi hệ thống. Vui lòng thử lại.");
                });
            });

            document.getElementById("otpForm").addEventListener("submit", function(e) {
                e.preventDefault();

                const otpValue = document.getElementById("otp-input").value;
                const email = document.getElementById("hidden-email").value;

                fetch("/register/verify-otp", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                    },
                    body: JSON.stringify({ email, otp: otpValue }),
                })
                .then((res) => res.json())
                .then((data) => {
                    if (data.success) {
                        alert(data.message);
                        window.location.href = "/login";
                    } else {
                        const errorOtp = document.getElementById("error-otp");
                        errorOtp.textContent = data.message || "Lỗi xác thực OTP.";
                        errorOtp.style.display = "block";
                    }
                })
                .catch(err => {
                    console.error(err);
                    alert("Lỗi hệ thống.");
                });
            });

            document.getElementById("backToRegister").addEventListener("click", function() {
                document.getElementById("otpSection").style.display = "none";
                document.getElementById("registerForm").style.display = "block";
            });

            // Thêm toggle mật khẩu
            const passInput = document.getElementById('password');
            const passToggle = document.getElementById('togglePassword');
            passToggle.addEventListener('click', function () {
                const type = passInput.getAttribute('type') === 'password' ? 'text' : 'password';
                passInput.setAttribute('type', type);
                this.querySelector('i').classList.toggle('fa-eye');
                this.querySelector('i').classList.toggle('fa-eye-slash');
            });

            const confirmPassInput = document.getElementById('confirmPassword');
            const confirmPassToggle = document.getElementById('toggleConfirmPassword');
            confirmPassToggle.addEventListener('click', function () {
                const type = confirmPassInput.getAttribute('type') === 'password' ? 'text' : 'password';
                confirmPassInput.setAttribute('type', type);
                this.querySelector('i').classList.toggle('fa-eye');
                this.querySelector('i').classList.toggle('fa-eye-slash');
            });

            let countdown = 60; // Đặt lại thời gian là 60 giây
            const resendBtn = document.getElementById('resendOTPBtn');
            const countdownSpan = document.getElementById('countdown');
            let emailValue = "";

            const timer = setInterval(() => {
                countdown--;
                countdownSpan.textContent = countdown;
                if (countdown <= 0) {
                    resendBtn.disabled = false;
                    resendBtn.textContent = "Gửi lại mã OTP";
                    clearInterval(timer);
                }
            }, 1000);

            resendBtn.addEventListener("click", async function (e) {
                e.preventDefault();
                resendBtn.disabled = true;
                resendBtn.textContent = "Đang gửi lại...";

                try {
                    const response = await fetch("/register/resend-otp", {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json"
                        },
                        body: JSON.stringify({ email: emailValue })
                    });

                    const data = await response.json();
                    if (data.success) {
                        countdown = 60; // Đặt lại thời gian là 60 giây
                        resendBtn.textContent = "Gửi lại mã OTP (60s)";
                        countdownSpan.textContent = countdown;
                        const restartTimer = setInterval(() => {
                            countdown--;
                            countdownSpan.textContent = countdown;
                            if (countdown <= 0) {
                                resendBtn.disabled = false;
                                resendBtn.textContent = "Gửi lại mã OTP";
                                clearInterval(restartTimer);
                            }
                        }, 1000);
                    } else {
                        resendBtn.textContent = "Lỗi gửi lại!";
                    }
                } catch (err) {
                    console.error("Lỗi gửi lại OTP:", err);
                    resendBtn.textContent = "Lỗi kết nối!";
                }
            });

            // Cập nhật emailValue khi chuyển sang OTP
            document.getElementById("registerForm").addEventListener("submit", function(e) {
                if (e) e.preventDefault();
                emailValue = document.getElementById("email").value;
            });
        </script>
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    </body>
</html>